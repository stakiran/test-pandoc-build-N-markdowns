<h2 id="scrapbox-to-markdown-画像とicon記法の実装">Scrapbox to Markdown 画像とicon記法の実装</h2>
<p>impl6</p>
<ul>
<li>画像いきます</li>
<li><a href="Gyazoのリンクから画像の直リンクを得る.md">Gyazoのリンクから画像の直リンクを得る</a>には？
<ul>
<li><a href="Gyazo_API.md">Gyazo API</a>使うしかなさそう</li>
<li>12500requests/日
<ul>
<li><a href="https://scrapbox.io/sta">/sta</a>が4500page、仮に5pageに1pageで画像1枚使ってるとすると、900枚</li>
<li>まあ問題なさそうか</li>
</ul></li>
<li>pagesize 1～100
<ul>
<li>100回をn回ぶん回すことになるね</li>
</ul></li>
</ul></li>
<li>実装は？
<ul>
<li>ステップ分けた方がいい</li>
<li>json to markdownする前に「画像リンクするのに必要な情報を集めてくるフェーズ」を設ける
<ul>
<li>コマンド一発で行えるようにする</li>
<li>トークンはたぶん用意してもらう必要があるな</li>
</ul></li>
</ul></li>
<li>つまり
<ul>
<li><code>.png</code>決め打ちでいいので変換をつくりきる</li>
<li>Gyazo API使って正しいurlをゲットする処理（というかコマンド）</li>
<li>↑ この二つがある</li>
</ul></li>
<li>変換済ませたいから、前者からいきまふ
<ul>
<li><a href="PythonでinlineのScrapbox記法をMarkdown記法に変換する正規表現.md">PythonでinlineのScrapbox記法をMarkdown記法に変換する正規表現</a></li>
<li>帰還</li>
<li>追加で以下が必要です
<ul>
<li><a href="Gyazo_API.md">Gyazo API</a>を使って画像のURLと縦横比を手に入れる（手に入れておく）</li>
<li>icon記法をパースして<code>&lt;img&gt;</code>タグに置換し、（その中身を）手に入れてた情報を使って仕上げる</li>
</ul></li>
<li>が、これは<code>scb_to_markdown_in_line()</code>より上のレイヤーの仕事なので、ここではしません</li>
</ul></li>
<li><a href="Scrapboxのicon記法表示時の縦横比.md">Scrapboxのicon記法表示時の縦横比</a> 調べる
<ul>
<li>行に収まるように配置している</li>
<li>imgタグのheight/widthではどう指定すればいい？
<ul>
<li>ScrapboxはCSSで処理してるっぽいけど、Markdownに載せる場合はimgタグの表現力しか使えない</li>
<li>だが<a href="HTMLのimgタグのheightやwidthで%は使っちゃダメ.md">HTMLのimgタグのheightやwidthで%は使っちゃダメ</a></li>
</ul></li>
</ul></li>
<li>imgタグ置換処理
<ul>
<li><code>:sta:</code></li>
<li><code>:sta:</code> 丸々カットして</li>
<li>replace <code>:XXX:</code> to <code>&lt;img src='ページXXXに載ってる画像のURL' width="同左縦横比に基づいたX" height="同左縦横比に基づいたY" /&gt;</code></li>
<li>markdown layerではCSSもjsも使えないから、結論として
<ul>
<li>pixel値だけで頑張る必要がある</li>
<li>行の高さはわからない（ので適当に決め打ちするしかない）</li>
</ul></li>
</ul></li>
<li>実装
<ul>
<li>repl.it用</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> <span class="st">&#39;&#39;&#39;画像 noindent</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="st">![](https://i.gyazo.com/e4aae2345d1927c777db267138d1e419.jpg)</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;br&gt;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="st">画像 indent</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="st">- ![](https://i.gyazo.com/639242beda8d44936421325524cd99f3.jpg)</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="st">    - ![](https://i.gyazo.com/777cfb7cd2528ebf90db1617ed659a40.jpg)</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;br&gt;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="st">- ユーザーアイコンはどうしましょうか:sta:</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="st">    - わかるー（x3 してます）:sta:</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="st">    - わかるー:sta::sta::sta:</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;br&gt;</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;&#39;&#39;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>lines <span class="op">=</span> s.split(<span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>RE_ICON_TO_REMOVE_NONGREEDY <span class="op">=</span> re.<span class="bu">compile</span>(<span class="vs">r&#39;\(.+?\.icon(\*[0-9]+){0,1}\.md\)&#39;</span>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>RE_ICON_TO_REPLACE_TO_IMG <span class="op">=</span> re.<span class="bu">compile</span>(<span class="vs">r&#39;\[(.+?)\.icon\]&#39;</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i,line <span class="kw">in</span> <span class="bu">enumerate</span>(lines):</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  newline <span class="op">=</span> line</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  newline <span class="op">=</span> re.sub(RE_ICON_TO_REMOVE_NONGREEDY, <span class="st">&#39;&#39;</span>, newline)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> line<span class="op">==</span>newline:</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">continue</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  newline <span class="op">=</span> re.sub(RE_ICON_TO_REPLACE_TO_IMG, <span class="st">&#39;&lt;img src=&quot;</span><span class="ch">\\</span><span class="st">1&quot; height=&quot;32&quot; /&gt;&#39;</span>, newline)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">&#39;</span><span class="sc">{}</span><span class="st">: </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(i, newline))</span></code></pre></div>
<ul>
<li>…
<ul>
<li>丸々カット
<ul>
<li><code>RE_ICON_TO_REMOVE = re.compile(r'\(.+\.icon(\*[0-9](0-9.md)+){0,1}\.md\)')</code>
<ul>
<li>これだと非貪欲にならん</li>
</ul></li>
<li><code>RE_ICON_TO_REMOVE_NONGREEDY = re.compile(r'\((.+\.icon(\*[0-9](0-9.md)+){0,1}\.md)?\)')</code>
<ul>
<li>これも結果変わらず</li>
<li>というか「非貪欲の<code>?</code>」は<code>?</code>か<code>*</code>か<code>+</code>につけるものか</li>
</ul></li>
<li><code>RE_ICON_TO_REMOVE_NONGREEDY = re.compile(r'\(.+?\.icon(\*[0-9](0-9.md)+){0,1}\.md\)')</code>
<ul>
<li>year!</li>
</ul></li>
</ul></li>
<li>imgタグ化
<ul>
<li><code>RE_ICON_TO_REPLACE_TO_IMG = re.compile(r'\[(.+?)\.icon(\*[0-9]((.+?)\.icon(\*[0-9.md)+){0,1}\]')</code></li>
<li><a href="https://gyazo.com/3ce91d9512e81b8c1b45e4af5df96176" target="_blank" rel="noopener noreferrer"><img src="https://gyazo.com/3ce91d9512e81b8c1b45e4af5df96176/raw" /></a></li>
<li><code>icon*3</code> ← このn-repeatの対処が難しい。。。</li>
</ul></li>
</ul></li>
</ul>
<p><br></p>
<h2 id="links">Links</h2>
<ul>
<li>← <a href="Scrapbox_to_Markdown.md">Scrapbox to Markdown</a></li>
<li>← <a href="アイコン記法を画像として埋め込む.md">アイコン記法を画像として埋め込む</a></li>
</ul>
<h2 id="hop-links">2hop Links</h2>
<ul>
<li>→ <a href="HTMLのimgタグのheightやwidthで%は使っちゃダメ.md">HTMLのimgタグのheightやwidthで%は使っちゃダメ</a>
<ul>
<li>← <a href="アイコン記法を画像として埋め込む.md">アイコン記法を画像として埋め込む</a></li>
</ul></li>
<li>→ <a href="Scrapboxのicon記法表示時の縦横比.md">Scrapboxのicon記法表示時の縦横比</a>
<ul>
<li>← <a href="アイコン記法を画像として埋め込む.md">アイコン記法を画像として埋め込む</a></li>
</ul></li>
<li>→ <a href="Gyazoのリンクから画像の直リンクを得る.md">Gyazoのリンクから画像の直リンクを得る</a>
<ul>
<li>← <a href="✅Gyazo埋め込みの画像を表示する.md">✅Gyazo埋め込みの画像を表示する</a></li>
<li>← <a href="Gyazo_API.md">Gyazo API</a></li>
</ul></li>
<li>→ <a href="PythonでinlineのScrapbox記法をMarkdown記法に変換する正規表現.md">PythonでinlineのScrapbox記法をMarkdown記法に変換する正規表現</a>
<ul>
<li>← <a href="Scrapbox_to_Markdown_文法変換の設計やら実装やら.md">Scrapbox to Markdown 文法変換の設計やら実装やら</a></li>
<li>← <a href="Scrapbox_to_Markdown_コードブロック.md">Scrapbox to Markdown コードブロック</a></li>
</ul></li>
<li>→ <a href="Gyazo_API.md">Gyazo API</a>
<ul>
<li>← <a href="✅Gyazo埋め込みの画像を表示する.md">✅Gyazo埋め込みの画像を表示する</a></li>
<li>← <a href="PythonでinlineのScrapbox記法をMarkdown記法に変換する正規表現.md">PythonでinlineのScrapbox記法をMarkdown記法に変換する正規表現</a></li>
<li>← <a href="Gyazoのリンクから画像の直リンクを得る.md">Gyazoのリンクから画像の直リンクを得る</a></li>
</ul></li>
</ul>
