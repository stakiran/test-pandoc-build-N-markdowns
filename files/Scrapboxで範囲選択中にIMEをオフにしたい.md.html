<h2 id="scrapboxで範囲選択中にimeをオフにしたい">Scrapboxで範囲選択中にIMEをオフにしたい</h2>
<p><br></p>
<p>まとめ</p>
<ul>
<li><code>「</code>が消えないとあまりシームレスじゃないので、使うのやめる</li>
<li>どうやったら消せるんだろうなぁこれ</li>
</ul>
<p><br></p>
<p><strong>元の入力は要らないので切り捨てたい</strong></p>
<ul>
<li>known issueだった</li>
<li>だめ
<ul>
<li>preventDefault や stopPropagation の組み合わせを変える</li>
<li>処理入った直後に実行してみる</li>
</ul></li>
<li><a href="https://qiita.com/pochman/items/b99c835bf598810d3c18">モダンブラウザにおけるキー入力のキャンセル - Qiita</a>
<ul>
<li>Firefoxの場合、keydownの後にcompositionupdateが発生するらしい</li>
<li>リスナー2つくって、クロージャかなんかで状態変数でやりとりすればいいかもしれない</li>
<li>ああ、ダメだ、IMEオンのときはkeydownに来ないんだ</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">//残骸。動かん</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">brackettingAlways</span>() {</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;keydown&#39;</span><span class="op">,</span> e <span class="kw">=&gt;</span> {</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>   <span class="kw">const</span> eData <span class="op">=</span> e<span class="op">.</span><span class="at">data</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>   <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(e)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> buttons <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementsByClassName</span>(<span class="st">&#39;popup-menu&#39;</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">?.</span>[<span class="dv">0</span>]<span class="op">?.</span><span class="fu">getElementsByClassName</span>(<span class="st">&#39;button&#39;</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>buttons) <span class="cf">return</span><span class="op">;</span> <span class="co">// そもそもpopup menuがなかったら何もしない</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (eData<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span>(eData<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;&#39;</span>)<span class="op">.</span><span class="fu">pop</span>()) {</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;「&#39;</span><span class="op">:</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">getElementsByClassName</span>(<span class="st">&#39;button link-button&#39;</span>)<span class="op">?.</span>[<span class="dv">0</span>]<span class="op">?.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">default</span><span class="op">:</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;compositionupdate&#39;</span><span class="op">,</span> e <span class="kw">=&gt;</span> {</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>   <span class="kw">const</span> eData <span class="op">=</span> e<span class="op">.</span><span class="at">data</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>   <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(e)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> buttons <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementsByClassName</span>(<span class="st">&#39;popup-menu&#39;</span>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>      <span class="op">?.</span>[<span class="dv">0</span>]<span class="op">?.</span><span class="fu">getElementsByClassName</span>(<span class="st">&#39;button&#39;</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>buttons) <span class="cf">return</span><span class="op">;</span> <span class="co">// そもそもpopup menuがなかったら何もしない</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (eData<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span>(eData<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;&#39;</span>)<span class="op">.</span><span class="fu">pop</span>()) {</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;「&#39;</span><span class="op">:</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">getElementsByClassName</span>(<span class="st">&#39;button link-button&#39;</span>)<span class="op">?.</span>[<span class="dv">0</span>]<span class="op">?.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">default</span><span class="op">:</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><br></p>
<p>**[thk**(thk.md) <a href="https://scrapbox.io/takker/IME%20onの時、キー入力をScrapboxに渡すUserScript">/takker/IME onの時、キー入力をScrapboxに渡すUserScript</a>]</p>
<ul>
<li>範囲選択しているかどうかは「popup menu出てるか」で判定する</li>
<li>出てたら0番目のbuttonをclick
<ul>
<li><a href="https://gyazo.com/c8698086e75e00dff4f9f2deb5ced683" target="_blank" rel="noopener noreferrer"><img src="https://gyazo.com/c8698086e75e00dff4f9f2deb5ced683/raw" /></a></li>
</ul></li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">execute</span>() {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;compositionupdate&#39;</span><span class="op">,</span> e <span class="kw">=&gt;</span> {</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> buttons <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementsByClassName</span>(<span class="st">&#39;popup-menu&#39;</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">?.</span>[<span class="dv">0</span>]<span class="op">?.</span><span class="fu">getElementsByClassName</span>(<span class="st">&#39;button&#39;</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>buttons) <span class="cf">return</span><span class="op">;</span> <span class="co">// そもそもpopup menuがなかったら何もしない</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (e<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span>(e<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;&#39;</span>)<span class="op">.</span><span class="fu">pop</span>()) {</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;「&#39;</span><span class="op">:</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        e<span class="op">.</span><span class="fu">stopPropagation</span>()<span class="op">;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">getElementsByClassName</span>(<span class="st">&#39;button link-button&#39;</span>)<span class="op">?.</span>[<span class="dv">0</span>]<span class="op">?.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">default</span><span class="op">:</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>} </span></code></pre></div>
<p><br></p>
<p><strong>やりたいこと</strong></p>
<ul>
<li>範囲選択中はほぼリンクをつける</li>
<li>IMEオンだとつかない → オフにして → つける、とかしてて面倒くさい</li>
<li><a href="UserScript.md">UserScript</a>でできないかしら
<ul>
<li>IME制御が無理ゲーな気がする</li>
<li>たぶんブラウザがセキュリティ的に許されてない</li>
</ul></li>
</ul>
<p><br></p>
<h2 id="hop-links">2hop Links</h2>
<ul>
<li>→ <a href="UserScript.md">UserScript</a>
<ul>
<li>← <a href="Scrapboxへの要望.md">Scrapboxへの要望</a></li>
<li>← <a href="ScrapCalc.md">ScrapCalc</a></li>
<li>← <a href="Scrapbox_As_A_Brarea.md">Scrapbox As A Brarea</a></li>
</ul></li>
</ul>
